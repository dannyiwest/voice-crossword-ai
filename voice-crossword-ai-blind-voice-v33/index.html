<!DOCTYPE html>
<html lang="en">
<head>

  
    
<style>
  body { margin:0; font-family: sans-serif; display:flex; flex-direction:column; justify-content: space-evenly; align-items: center; height:100vh; }
  #status { padding:1rem; text-align:center; font-size:1rem; flex:0 0 auto; }
  #btn-container { flex:1; display:flex; flex-direction: column; justify-content: space-evenly; align-items: center; width:100%; }
  #btn-container button { width:80%; height:160px; font-size:3.2rem; margin: 0; }
  #genre-btn { background: blue; }
  #hint-btn { background: green; }
  #start-btn { background: orange; }
  #mic-meter { width:80%; height:32px; background:#eee; margin-top:1rem; }
  #mic-fill { height:100%; background:#4caf50; width:0%; }
  #progress-bar { width:80%; height:16px; background:#eee; margin:10px 0; }
  #progress-fill { width:0%; height:100%; background:#2196f3; }
  #transcript { padding:1rem; font-size:1.6rem; text-align:center; width:80%; }
  #debug-log { width:80%; height:150px; background:#333; color:#0f0; font-size:1rem; overflow:auto; margin-top:10px; padding:5px; }
</style>



  
<style>
  body { margin:0; font-family: sans-serif; display:flex; flex-direction:column; justify-content: space-evenly; align-items: center; height:100vh; }
  #status { padding:1rem; text-align:center; font-size:1rem; flex:0 0 auto; }
  #btn-container { flex:1; display:flex; flex-direction: column; justify-content: space-evenly; align-items: center; width:100%; }
  #btn-container button { width:80%; height:160px; font-size:3.2rem; margin: 0; }
  #genre-btn { background: blue; }
  #hint-btn { background: green; }
  #start-btn { background: orange; }
  #mic-meter { width:80%; height:32px; background:#eee; margin-top:1rem; }
  #mic-fill { height:100%; background:#4caf50; width:0%; }
  #progress-bar { width:80%; height:16px; background:#eee; margin:10px 0; }
  #progress-fill { width:0%; height:100%; background:#2196f3; }
  #transcript { padding:1rem; font-size:1.6rem; text-align:center; width:80%; }
  #debug-log { width:80%; height:150px; background:#333; color:#0f0; font-size:1rem; overflow:auto; margin-top:10px; padding:5px; }
</style>

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Voice Crossword PWA</title>
</head>

<body>
  <div id="status">Tap "Start Quiz" to begin</div>
  <div id="btn-container">
    <button id="start-btn" class="big-button" aria-label="Start Quiz">Start Quiz</button>
    <button id="genre-btn" aria-label="Genres">Genres</button>
    <button id="hint-btn" aria-label="Hint">Hint</button>
  </div>
  <div id="mic-meter"><div id="mic-fill"></div></div>

  <div id="progress-bar" style="width:100%; background:#eee; height:20px; display:none; margin:10px 0;">
    <div id="progress-fill" style="width:0%; height:100%; background:#2196f3;"></div>
  </div>
  <div id="transcript">Waiting...</div>
  <div id="debug-log"></div>

<script>
let debugMode = true;
function debug(msg) {
  if (!debugMode) return;
  const log = document.getElementById("debug-log");
  const entry = document.createElement("div");
  entry.textContent = msg;
  log.appendChild(entry);
}

function showProgressBar() {
  debug("showProgressBar");
  const bar = document.getElementById('progress-bar');
  const fill = document.getElementById('progress-fill');
  bar.style.display = 'block';
  fill.style.width = '0%';
  window.progressInterval = setInterval(() => {
    let w = parseFloat(fill.style.width);
    if (w < 90) fill.style.width = (w + 10) + '%';
  }, 200);
}
function hideProgressBar() {
  debug("hideProgressBar");
  clearInterval(window.progressInterval);
  const bar = document.getElementById('progress-bar');
  const fill = document.getElementById('progress-fill');
  fill.style.width = '100%';
  setTimeout(() => bar.style.display = 'none', 300);
}


let currentGenre = "", questions = [], idx = 0, expectedAnswer = "";
const genres = ["food"];

function speak(text, cb) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'en-US';
  msg.rate = 0.9;
  msg.onend = cb || function(){};
  speechSynthesis.speak(msg);
  document.getElementById('status').textContent = text;
}

function startMicMeter() {
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = ctx.createAnalyser();
    ctx.createMediaStreamSource(stream).connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);
    function update() {
      analyser.getByteTimeDomainData(data);
      let sum = 0;
      data.forEach(v => sum += ((v-128)/128)**2);
      document.getElementById("mic-fill").style.width = Math.min(100, Math.sqrt(sum/data.length)*300) + "%";
      requestAnimationFrame(update);
    }
    update();
  }).catch(err => console.error("Mic meter error:", err));
}

function listGenres() {
  const prompt = "Available genre is: " + genres.join(", ");
  speak(prompt);
}


async function fetchQuestions(genre) {
  debug("fetchQuestions called for " + genre);
  showProgressBar();
  const res = await fetch('/.netlify/functions/q?genre=' + genre);
  debug("fetch response status: " + res.status);
  const qs = await res.json();
  hideProgressBar();
  questions = qs;
  debug("questions loaded: " + questions.length);
}


function listenForGenre() {
  const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang = 'en-US';
  rec.start();
  rec.onresult = e => {
    const g = e.results[0][0].transcript.trim().toLowerCase();
    document.getElementById('transcript').textContent = g;
    if (genres.includes(g)) {
      currentGenre = g;
      speak("Loading quiz for " + currentGenre, async () => {
        await fetchQuestions(currentGenre);
        idx = 0;
        expectedAnswer = questions[idx].answer.toLowerCase();
        speak("Starting quiz", () => askQuestion());
      });
    } else {
      speak("Genre not recognized. Please say food", () => listenForGenre());
    }
  };
  rec.onerror = () => speak("Error listening for genre. Try again.", () => listenForGenre());
}

function askQuestion() {
  debug("askQuestion idx=" + idx);
  const q = questions[idx];
  expectedAnswer = q.answer.toLowerCase();
  speak("Question " + (idx+1), () => {
    speak(q.question, () => listenForAnswer());
  });
}

function listenForAnswer() {
  debug("listenForAnswer");
  const rec = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.lang = 'en-US';
  rec.start();
  rec.onresult = e => {
    const ans = e.results[0][0].transcript.trim().toLowerCase();
    document.getElementById('transcript').textContent = ans;
    if (ans === "hint") {
      speak("Hint: " + questions[idx].hint, () => listenForAnswer());
    } else if (ans === expectedAnswer) {
      speak("Correct", () => {
        idx = (idx + 1) % questions.length;
        askQuestion();
      });
    } else {
      speak("Incorrect. The correct answer was " + questions[idx].answer, () => {
        idx = (idx + 1) % questions.length;
        askQuestion();
      });
    }
  };
  rec.onerror = () => {
    speak("I didn't catch that. Please repeat.", () => listenForAnswer());
  };
}

// Button handlers
document.getElementById('genre-btn').onclick = () => {
  startMicMeter();
  listGenres();
  listenForGenre();
};
document.getElementById('hint-btn').onclick = () => speak("Hint: " + (questions[idx]?.hint || ""), () => {});

</script>
</body>
</html>